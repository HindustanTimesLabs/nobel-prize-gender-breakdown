function ready(t,e){function r(t){var e=[{start_year:t[0].year,end_year:t[1].year}],r=m.selectAll(".control-rect").data(t,function(t){return t.name}),n=m.selectAll(".control-text").data(t,function(t){return t.name}),a=m.selectAll(".control-bg").data(e,function(t,e){return e});a.attr("width",function(t){return v(t.end_year)-v(t.start_year)}).attr("x",function(t){return v(t.start_year)}),r.attr("cx",function(t,e){return v(t.year)}),n.attr("x",function(t,e){return v(t.year)}).text(function(t){return t.year}),a.enter().append("rect").attr("class","control-bg").attr("height",function(t){return 18}).attr("width",function(t){return v(t.end_year)-v(t.start_year)}).attr("x",function(t){return v(t.start_year)}).attr("y",9).style("fill","#eee").style("stroke","#888"),r.enter().append("circle").attr("class","control-rect").attr("r",18).attr("cx",function(t,e){return v(t.year)}).attr("cy",18),n.enter().append("text").attr("class","control-text").attr("x",function(t,e){return v(t.year)}).attr("y",18).attr("dy",4).text(function(t){return t.year})}function n(t,n){d3.select(this).moveToFront(),d3.selectAll(".control-text").moveToFront();var o=[0,0];o=d3.mouse(this);var c=o[0],d=t.name,s=v.invert(c);s=s<u[0]?u[0]:s>u[1]?u[1]:s,s=Math.round(s),"start_year"==d?(s>=h[1].year&&(s=h[1].year),h[0].year=s):(s<=h[0].year&&(s=h[0].year),h[1].year=s);var l=h[0].year,f=h[1].year;k[k.length-1]=[l,f],a(l,f),x.forEach(function(t){var n=_.where(e,{type:t}),a=b[t];r(h),i(h[0].year,h[1].year,n,a.svg,a.width,a.height,a.x,a.y)})}function a(t,r){t!=r&&r==u[1]?$(".sentence-range").html("Since "+t):t==r?$(".sentence-range").html("In "+t):$(".sentence-range").html("Between "+t+" and "+r);var n=e.filter(function(e){return e.year>=t&&e.year<=r}),a=_.where(n,{gender:"org"}).length,i=_.where(n,{gender:"female"}).length,o=_.where(n,{gender:"male"}).length;$(".sentence-org").html(a+" organisation"+(1==a?"":"s")+" <span class='inline org'>"+Math.round(a/n.length*100)+"%</span>"),$(".sentence-female").html(i+" "+(1==a?"woman":"women")+" <span class='inline female'>"+Math.round(i/n.length*100)+"%</span>"),$(".sentence-male").html(o+" "+(1==a?"man":"men")+" <span class='inline male'>"+Math.round(o/n.length*100)+"%</span>")}function i(t,e,r,n,a,i,c,u){o(t,e),l(s(t,e,r),d(t,e),n,a,i,c,u)}function o(t,e){var r=t==e?t:t+" &mdash; "+e;$(".viz-title .year-range").html(r)}function c(t){return Math.ceil(Math.sqrt(t))}function d(t,r){return c(d3.max(x.map(function(n){return e.filter(function(e){return e.type==n&&e.year>=t&&e.year<=r}).length})))}function s(t,e,r){return r.filter(function(r){return+r.year>=t&&+r.year<=e})}function l(t,e,r,n,a,i,o){function d(){return"translate("+((n+20)/2-g/2)+", "+-29+")"}function s(){return"translate("+((n+20)/2-g/2)+", "+-29+")"}function l(t){return t.count>99?".5em":".7em"}function u(t){return t.count>99?3:4}function h(){d3.selectAll(".winner").classed("selected",!1),$(".tip").hide()}function f(t){function e(t){return Number(t.split("px")[0])}$(".tip").show(),d3.select(this).classed("selected",!0),$(".tip .name").html(t.name),$(".tip .country-of-birth").html(t.country),$(".tip .year").html(t.year),$(".tip .for").html(jz.str.toSentenceCase(t.description)+".");var r=d3.select(this).node().getBoundingClientRect(),n=r.x,a=o(t.column),c=$(".tip").height(),d=$(".tip").width(),s=e($(".tip").css("padding-left"))+e($(".tip").css("padding-right")),l=(e($(".tip").css("padding-top")),e($(".tip").css("padding-bottom")),$(".type-wrapper ."+t.type).offset().top),u=($(".type-wrapper ."+t.type).offset().left,d3.min([i.bandwidth(),o.bandwidth()]),n+r.width/2-d/2-s/2);u=u<0?0:u+d>ww?ww-d:u;var h=a+l-c+45;$(".tip").css({left:u,top:h})}function p(t,e){var r=[];t.forEach(function(t,r){return t.column=Math.ceil((r+1)/e),t});for(var n=1;n<=e;n++){t.filter(function(t){return t.column==n}).forEach(function(t,e){t.row=e+1,r.push(t)})}return r}if(!e)var e=c(t.length);var m=_.chain(t).pluck("gender").uniq().value().sort(),g=25*m.length,w=d3.scaleBand().rangeRound([0,g]).domain(m).padding(.2),v=r.selectAll(".legend-circle").data(m,function(t){return t}),y=r.selectAll(".legend-text").data(m.map(function(e){return{gender:e,count:_.where(t,{gender:e}).length}}),function(t){return t.gender});v.exit().transition().attr("r",0).remove(),y.exit().transition().remove(),v.transition().attr("cx",function(t){return w(t)}).attr("cy",0).attr("r",w.bandwidth()/2).attr("transform",d),y.transition().attr("x",function(t){return w(t.gender)}).attr("y",0).attr("transform",s).style("font-size",l).attr("dy",u).text(function(t){return t.count}),v.enter().append("circle").attr("class","legend-circle").attr("cx",function(t){return w(t)}).attr("cy",0).attr("r",w.bandwidth()/2).attr("fill",function(t){return colors[t]}).attr("transform",d),y.enter().append("text").attr("class",function(t){return"legend-text "+t.gender}).attr("x",function(t){return w(t.gender)}).attr("y",0).attr("dy",u).attr("text-anchor","middle").style("font-size",l).style("fill","#fff").attr("transform",s).text(function(t){return t.count});for(var b=e<5?.03:.1,x=[],k=[],z=1;z<=e;z++)x.push(z),k.push(z);i.domain(x).padding(b),o.domain(k).padding(b);var A=r.selectAll(".winner").data(p(t,e),function(t){return t.id});A.exit().transition().attr("r",0).remove(),A.on("mouseover",f).on("mouseout",h).transition().attr("cx",function(t){return i(t.row)+i.bandwidth()/2}).attr("cy",function(t){return o(t.column)+o.bandwidth()/2}).attr("r",d3.min([i.bandwidth(),o.bandwidth()])/2),A.enter().append("circle").attr("class","winner").attr("cx",function(t){return i(t.row)+i.bandwidth()/2}).attr("cy",function(t){return o(t.column)+o.bandwidth()/2}).style("fill",function(t){return colors[t.gender]}).attr("r",0).on("mouseover",f).on("mouseout",h).transition().attr("r",d3.min([i.bandwidth(),o.bandwidth()])/2)}if(t)throw t;e.forEach(function(t,e){return t.id=e,t});var u=d3.extent(e,function(t){return+t.year});a(u[0],u[1]);var h=[{name:"start_year",year:u[0]},{name:"end_year",year:u[1]}],f=(u[0],u[1],d3.marcon().width($("#scroll .frame").width()).height(72).top(0).bottom(36).right(18).left(18).element("#playground-controls"));f.render();for(var p=f.innerWidth(),m=(f.innerHeight(),f.svg()),g=[],w=u[0];w<=u[1];w++)g.push(w);var v=d3.scaleLinear().range([0,p]).domain(u);m.append("rect").attr("height",18).attr("width",p).attr("x",0).attr("y",9).attr("rx",10).attr("ry",10).style("fill","#fff").style("stroke","rgb(170, 170, 170)");var y=d3.axisBottom(v).tickFormat(function(t){return t.toString().replace(",","")});m.append("g").attr("class","controls-axis").attr("transform","translate(0,34)").call(y),r(h);var b={},x=_.chain(e).pluck("type").uniq().value().sort(),k=[[2017,2017],[2016,2016],[2015,2015],[2015,2017],[2e3,2017],[1901,2017]];x.forEach(function(t,r){$("#viz").append("<div class='type-wrapper "+t+"'></div>");var n=(_.where(e,{type:t}),d3.marcon().element(".type-wrapper."+t).width(resp.width).height(resp.height).left(10).right(10).top(60).bottom(60));n.render();var a=n.innerWidth(),i=n.innerHeight(),o=n.svg(),c=d3.scaleBand().range([0,a]).padding(padding),d=d3.scaleBand().range([0,i]).padding(padding);b[t]={width:a,height:i,svg:o,x:c,y:d},o.append("text").attr("class","type-title "+t).attr("x",a/2).attr("y",-45).text(jz.str.toStartCase(t))}),$(".frame").each(function(t,r){var n=$(window).height(),a=$(window).width(),o=0;o=a<=768?0==t?2*n:1.7*n:n/2,new Waypoint({element:$(this),handler:function(r){x.forEach(function(n){var a=_.where(e,{type:n}),o=b[n];"down"==r?i(k[t][0],k[t][1],a,o.svg,o.width,o.height,o.x,o.y):t-1!=-1&&i(k[t-1][0],k[t-1][1],a,o.svg,o.width,o.height,o.x,o.y)}),$(".end-year").attr("min",1901).attr("max",2017).val(2017),$(".start-year").attr("min",1901).attr("max",2017).val(1901)},offset:o})}),d3.selectAll(".control-rect").call(d3.drag().on("drag",n)),d3.selectAll(".control-text").call(d3.drag().on("drag",n)),new Waypoint({element:$("#viz"),handler:function(t){"down"==t?($("#viz").removeClass("above"),$("#scroll").removeClass("above"),$(".footer").show()):($("#viz").addClass("above"),$("#scroll").addClass("above"),$(".footer").hide())},offset:40}),new Waypoint({element:$("#section-2"),handler:function(t){"down"==t?($("#section-2").removeClass("above above-2"),$("#viz").css({position:"absolute",top:$("#section-2").offset().top-$(window).height()})):($("#section-2").addClass("above above-2"),$("#viz").css({position:"fixed",top:40}))},offset:$(window).height()*(ww<=768?2:1)}),drawTimeChart(prepareTimeData(e))}function prepareTimeData(t){for(var e=d3.extent(t,function(t){return+t.year}),r=[],n=["male","female","org"],a=e[0];a<=e[1];a+=10){var i=a+9>e[1]?e[1]:a+9,o={};o.decade=a+"-"+i,o.start_year=a,o.end_year=i,o.sum=0;var c=t.filter(function(t){return t.year>=a&&t.year<=i});n.forEach(function(t){o[t]=_.where(c,{gender:t}).length,o.sum=o.sum+o[t]}),n.forEach(function(t){o[t+"_pct"]=o[t]/o.sum*100}),r.push(o)}return r}function drawTimeChart(t){function e(t){u.domain([0,100]),d.select(".y").transition().call(r),a.forEach(function(e,r){var n=d.selectAll(".bar-"+e).data(p(t)[r],function(t){return t.data.decade+"-"+e});n.transition().attr("x",function(t){return l(t.data.decade)}).attr("y",function(t){return u(t[1])}).attr("height",function(t){return u(t[0])-u(t[1])}),n.enter().append("rect").attr("class",function(t){return"bar bar-"+e}).attr("x",function(t){return l(t.data.decade)}).attr("y",function(t){return u(t[1])}).attr("height",function(t){return u(t[0])-u(t[1])}).attr("width",l.bandwidth()).attr("fill",function(t){return s[e.split("_")[0]]})})}function r(t){t.call(f),t.selectAll(".tick:not(:first-of-type) line").attr("stroke","#777").attr("stroke-dasharray","2,2"),t.selectAll(".tick text").attr("x",4).attr("dy",-4)}var n=_.chain(t).pluck("decade").uniq().value(),a=["female_pct","male_pct","org_pct"],i=d3.marcon().top(20).bottom(20).left(10).right(10).width(d3.min([resp.chart_width,800])).height(400).element("#time-chart .chart-wrapper");i.render();var o=i.innerWidth(),c=i.innerHeight(),d=i.svg(),s={male:"#48a2d7",female:"#e74c3c",org:"#ccc"},l=d3.scaleBand().rangeRound([0,o]).domain(n).padding(.25),u=d3.scaleLinear().rangeRound([c,0]),h=d3.axisBottom(l),f=d3.axisRight(u).tickSize(o).tickFormat(function(t,e,r){return e==r.length-1?t+"%":t});d.append("g").attr("class","x axis").attr("transform","translate(0,"+c+")").call(h),d.append("g").attr("class","y axis").call(r);var p=d3.stack().keys(a).order(d3.stackOrderNone).offset(d3.stackOffsetNone);e(t)}window.onbeforeunload=function(){window.scrollTo(0,0)};var isMobile=!1;(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0,4)))&&(isMobile=!0);var ww=$(window).width();if(isMobile)$(".footer").show();else{var resp={};resp.width=$("#viz").width()/3,resp.height=window.innerHeight/2-$("#viz .viz-title").height()-Number($("#viz").css("padding-top").split("px")[0]),resp.chart_width=ww,$("body").append("<div class='tip'><div class='name'></div><div class='year'></div><div class='country-of-birth'></div><div class='for'></div></div>"),$(".tip").hide();var colors={male:"#48a2d7",female:"#e74c3c",org:"#ccc"};padding=0,d3.queue().defer(d3.csv,"data/all.csv").await(ready)}var f=!0;$(".title-background").flip(),d3.interval(function(){$(".title-background .back img").show(),$(".title-background").flip(f),f=1!=f,$(".title-background").flip()},3e3);